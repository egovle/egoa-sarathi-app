
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    function isAuth() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuth() && 
             exists(/databases/$(database)/documents/vles/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/vles/$(request.auth.uid)).data.isAdmin == true;
    }

    // --- User & VLE Profiles ---
    // Users can read/write their own profile. Admins can read/write any profile.
    // Crucially, wallet balances can only be updated by admins.
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isAuth(); // For registration
      allow update: if (isOwner(userId) && request.resource.data.walletBalance == resource.data.walletBalance) || isAdmin();
    }
    
    match /vles/{vleId} {
      allow read: if isOwner(vleId) || isAdmin();
      allow create: if isAuth(); // For registration
      allow update: if (isOwner(vleId) && request.resource.data.walletBalance == resource.data.walletBalance) || isAdmin();
    }
    
    // --- Public & Semi-Public Collections ---
    
    // Services: Any logged-in user can read services. Only admins can write.
    match /services/{serviceId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    // Camps: Any logged-in user can read camps. Only admins can write.
    match /camps/{campId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    // Notifications: Users can only manage their own notifications.
    match /notifications/{notificationId} {
       allow create: if isAuth();
       allow read, update, delete: if isOwner(resource.data.userId);
    }
    
    // Payment Requests: Users can create their own requests. Admins can read/update all.
    match /paymentRequests/{requestId} {
      allow create: if isOwner(request.resource.data.userId);
      allow read, update: if isAdmin();
    }

    // --- Core Business Logic ---
    
    // Tasks: Complex rules for tasks.
    match /tasks/{taskId} {
      // Any authenticated user can create a task.
      allow create: if isAuth();
      
      // Read access: For task creator, assigned VLE, or admin.
      allow read: if isOwner(resource.data.creatorId) || 
                     isOwner(resource.data.assignedVleId) || 
                     isAdmin();
                     
      // Update access: 
      // Admins can always update.
      // Assigned VLE can update.
      // The creator can only update specific fields like complaint, feedback, or documents.
      allow update: if isAdmin() || isOwner(resource.data.assignedVleId) ||
                       (isOwner(resource.data.creatorId) && 
                         (request.resource.data.complaint != resource.data.complaint || 
                          request.resource.data.feedback != resource.data.feedback ||
                          request.resource.data.documents != resource.data.documents)
                       );
    }
  }
}
